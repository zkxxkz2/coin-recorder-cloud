<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSONBin.io 数据读取测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .bin-id-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
            font-family: monospace;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .loading {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 JSONBin.io 数据读取测试</h1>
        
        <div class="status" id="status">准备就绪</div>
        
        <div class="test-section">
            <h3>📖 读取现有 Bin</h3>
            <p>输入 Bin ID 来测试读取数据：</p>
            <input type="text" id="binIdInput" class="bin-id-input" placeholder="输入 Bin ID，例如: 68eb169543b1c97be9637192">
            <button onclick="testReadBin()">读取数据</button>
            <button onclick="testKnownBins()">测试已知 Bin IDs</button>
            <div id="readResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>🧪 创建测试 Bin</h3>
            <p>创建一个新的测试 bin 来验证 API 功能：</p>
            <button onclick="testCreateBin()">创建测试 Bin</button>
            <div id="createResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>📊 数据统计</h3>
            <button onclick="showDataStats()">显示数据统计</button>
            <div id="statsResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script type="module">
        // 导入配置
        import { jsonbinConfig } from './jsonbin-config.js';
        
        let currentBinId = null;
        
        // 更新状态
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }
        
        // 显示结果
        function showResult(elementId, content, type = 'info') {
            const resultEl = document.getElementById(elementId);
            resultEl.textContent = content;
            resultEl.className = `result ${type}`;
            resultEl.style.display = 'block';
        }
        
        // 测试读取指定 Bin
        window.testReadBin = async function() {
            const binId = document.getElementById('binIdInput').value.trim();
            if (!binId) {
                showResult('readResult', '请输入 Bin ID', 'error');
                return;
            }
            
            updateStatus('正在读取数据...', 'loading');
            
            try {
                const response = await fetch(`${jsonbinConfig.baseUrl}/b/${binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': jsonbinConfig.apiKey
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentBinId = binId;
                    
                    const summary = `
✅ 读取成功!

📊 数据概览:
- Bin ID: ${binId}
- 金币记录数: ${result.record.coinRecords?.length || 0}
- 用户数: ${result.record.users?.length || 0}
- 成就数: ${result.record.achievements ? Object.keys(result.record.achievements).length : 0}
- 最后同步: ${result.record.lastSync || '未知'}

👤 用户信息:
${result.record.users?.map((user, i) => `   ${i + 1}. 用户名: ${user.username}, ID: ${user.id}`).join('\n') || '   无用户数据'}

💰 最近的金币记录:
${result.record.coinRecords?.slice(-3).map((record, i) => `   ${i + 1}. ${record.date}: ${record.coins} 金币`).join('\n') || '   无金币记录'}

📄 完整数据:
${JSON.stringify(result.record, null, 2)}
                    `;
                    
                    showResult('readResult', summary, 'success');
                    updateStatus('数据读取成功!', 'success');
                } else {
                    const errorText = await response.text();
                    showResult('readResult', `❌ 读取失败: ${response.status} ${response.statusText}\n错误信息: ${errorText}`, 'error');
                    updateStatus('数据读取失败', 'error');
                }
            } catch (error) {
                showResult('readResult', `❌ 网络错误: ${error.message}`, 'error');
                updateStatus('网络错误', 'error');
            }
        };
        
        // 测试已知的 Bin IDs
        window.testKnownBins = async function() {
            const knownBinIds = [
                '68eb169543b1c97be9637192',
                '68eb146843b1c97be9637070',
                '68eb142fae596e708f0f2744'
            ];
            
            updateStatus('正在测试已知 Bin IDs...', 'loading');
            
            let results = '🔍 测试已知 Bin IDs:\n\n';
            let successCount = 0;
            
            for (const binId of knownBinIds) {
                try {
                    const response = await fetch(`${jsonbinConfig.baseUrl}/b/${binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': jsonbinConfig.apiKey
                        }
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        results += `✅ ${binId}: 成功\n`;
                        results += `   - 用户: ${result.record.users?.length || 0} 个\n`;
                        results += `   - 记录: ${result.record.coinRecords?.length || 0} 条\n`;
                        results += `   - 同步: ${result.record.lastSync || '未知'}\n\n`;
                        successCount++;
                    } else {
                        results += `❌ ${binId}: ${response.status} ${response.statusText}\n\n`;
                    }
                } catch (error) {
                    results += `❌ ${binId}: ${error.message}\n\n`;
                }
            }
            
            results += `📊 测试结果: ${successCount}/${knownBinIds.length} 个 Bin 可访问`;
            
            showResult('readResult', results, successCount > 0 ? 'success' : 'error');
            updateStatus(`测试完成: ${successCount}/${knownBinIds.length} 成功`, successCount > 0 ? 'success' : 'error');
        };
        
        // 测试创建 Bin
        window.testCreateBin = async function() {
            updateStatus('正在创建测试 Bin...', 'loading');
            
            const testData = {
                test: true,
                message: '这是一个测试数据',
                timestamp: new Date().toISOString(),
                coinRecords: [],
                streakData: {
                    currentStreak: 0,
                    longestStreak: 0,
                    lastRecordDate: null,
                    todayCompleted: false
                },
                achievements: null,
                challengeData: {
                    target: 0,
                    startDate: null,
                    endDate: null,
                    currentProgress: 0,
                    completed: false,
                    completedDate: null
                },
                lastSync: new Date().toISOString(),
                users: []
            };
            
            try {
                const response = await fetch(`${jsonbinConfig.baseUrl}/b`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': jsonbinConfig.apiKey
                    },
                    body: JSON.stringify(testData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    currentBinId = result.metadata.id;
                    
                    const summary = `
✅ 测试 Bin 创建成功!

📊 Bin 信息:
- Bin ID: ${result.metadata.id}
- 创建时间: ${result.metadata.createdAt}
- 私有: ${result.metadata.private}

📄 创建的数据:
${JSON.stringify(result.record, null, 2)}
                    `;
                    
                    showResult('createResult', summary, 'success');
                    updateStatus('测试 Bin 创建成功!', 'success');
                    
                    // 自动填充到输入框
                    document.getElementById('binIdInput').value = result.metadata.id;
                } else {
                    const errorText = await response.text();
                    showResult('createResult', `❌ 创建失败: ${response.status} ${response.statusText}\n错误信息: ${errorText}`, 'error');
                    updateStatus('测试 Bin 创建失败', 'error');
                }
            } catch (error) {
                showResult('createResult', `❌ 网络错误: ${error.message}`, 'error');
                updateStatus('网络错误', 'error');
            }
        };
        
        // 显示数据统计
        window.showDataStats = function() {
            if (!currentBinId) {
                showResult('statsResult', '请先读取一个 Bin 的数据', 'error');
                return;
            }
            
            updateStatus('正在分析数据...', 'loading');
            
            // 这里可以添加更详细的数据分析
            const stats = `
📊 数据统计分析

当前 Bin ID: ${currentBinId}

💡 提示: 这是一个基础的数据读取测试工具。
要获得详细的数据统计，请先使用"读取数据"功能获取完整数据。

🔧 功能说明:
- 读取现有 Bin 数据
- 创建测试 Bin
- 验证 API 连接
- 检查数据完整性
            `;
            
            showResult('statsResult', stats, 'info');
            updateStatus('数据统计完成', 'info');
        };
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('JSONBin.io 数据读取测试工具已就绪', 'success');
        });
    </script>
</body>
</html>
